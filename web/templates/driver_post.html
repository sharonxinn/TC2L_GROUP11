<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Post</title>
    <link rel="stylesheet" href="../static/driver_post.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2un2GtIOA0jUz-BXUs34Vj-mIfsCiRdk&callback=initMap&libraries=places&v=beta" async defer></script>
    
    <script>
        let map;
        let marker;
        let originalLocation;

        window.onload = function() {
        initMap();
        };

        function initMap() {
            originalLocation = { lat: 2.9278, lng: 101.6419 }; // Default location (Example: MMU Cyberjaya)
            
            map = new google.maps.Map(document.getElementById("map"), {
                center: originalLocation,
                zoom: 15
            });

            marker = new google.maps.Marker({
                position: originalLocation,
                map: map,
                title: "start_location Location",
                draggable: true
            });

            // Update hidden fields with initial location
            updateHiddenFields(originalLocation);

            // Event listener for marker drag
            marker.addListener('dragend', function(event) {
                const newLocation = { lat: event.latLng.lat(), lng: event.latLng.lng() };
                if (isWithinRadius(originalLocation, newLocation, 10000)) { // 10000 meters = 10 km
                    updateHiddenFields(newLocation);
                } else {
                    alert("Marker can only be moved within 10 km of the original location.");
                    marker.setPosition(originalLocation); // Reset marker position
                }
            });
        }

        // Update hidden fields with the marker's current position
        function updateHiddenFields(location) {
            document.getElementById("start_location_lat").value = location.lat;
            document.getElementById("start_location_lng").value = location.lng;
        }

        // Check if the new location is within a certain radius from the original location
        function isWithinRadius(originalLocation, newLocation, radius) {
            const R = 6371000; // Radius of the Earth in meters
            const dLat = toRadians(newLocation.lat - originalLocation.lat);
            const dLng = toRadians(newLocation.lng - originalLocation.lng);
            const lat1 = toRadians(originalLocation.lat);
            const lat2 = toRadians(newLocation.lat);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.sin(dLng / 2) * Math.sin(dLng / 2) *
                      Math.cos(lat1) * Math.cos(lat2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in meters

            return distance <= radius;
        }

        // Convert degrees to radians
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // Update map and hidden fields based on the selected start_location location
        function updateMapLocation() {
            const locations = {
                "Taman Puchong Utama": { lat: 2.9917, lng: 101.6156 },
                "Taman Puchong Prima": { lat: 2.9818, lng: 101.5999 },
                "Taman Kinrara": { lat: 3.0643, lng: 101.6396 },
                "MRT Cyberjaya Utara": { lat: 2.9505, lng: 101.6568 },
                "MRT Cyberjaya Centre": { lat: 2.9402, lng: 101.6654 },
                "Garden Plaza Residence": { lat: 2.9494, lng: 101.6646 },
                "Lakefront Residence": { lat: 2.9323, lng: 101.6305 },
                "Dpulze": { lat: 2.9221, lng: 101.6510 },
                "TamarindSquare": { lat: 2.9214, lng: 101.6365 },
                "MutiaraVille": { lat: 2.9239, lng: 101.6339 },
                "TheArc": { lat: 2.926, lng: 101.6360 }
            };

            const selectedLocation = document.getElementById("start_location").value;
            const newLocation = locations[selectedLocation];

            if (newLocation) {
                map.setCenter(newLocation);
                marker.setPosition(newLocation);

                // Update hidden fields
                updateHiddenFields(newLocation);
            }
        }
    </script>
</head>

<body>
    <div class="logout">
        <a href="/">
            <input type="image" src="../static/pic&video/logout icon.png" width="50px" height="50px">
        </a>
    </div>

    <div class="outside-center">
        <h1 align="center">Post A Ride</h1>
        <div class="middle-box">
            <form action="{{ url_for('main.driver_post') }}" method="post">
                <div class="inner-center">
                    <label for="dateandTime">Date & Time</label>
                    <br>
                    <input type="datetime-local" id="dateandTime" name="dateandTime" required><br>
                    
                    <script>
                        var today = new Date().toISOString().slice(0, 16);
                        document.getElementsByName("dateandTime")[0].min = today;
                    </script>
                </div>

                <div class="left-right">
                    <div class="inner-center">
                        <label for="start_location">Start Location</label>
                        <br>
                        <select name="start_location" id="start_location" onchange="updateMapLocation()" required>
                            <option value="Taman Puchong Utama">Taman Puchong Utama</option>
                            <option value="Taman Puchong Prima">Taman Puchong Prima</option>
                            <option value="Taman Kinrara">Taman Kinrara</option>
                            <option value="MRT Cyberjaya Utara">MRT Cyberjaya Utara</option>
                            <option value="MRT Cyberjaya Centre">MRT Cyberjaya City Centre</option>
                            <option value="Garden Plaza Residence">Garden Plaza Residence</option>
                            <option value="Lakefront Residence">Lakefront Residence</option>
                            <option value="Dpulze">Dpulze</option>
                            <option value="TamarindSquare">Tamarind Square</option>
                            <option value="MutiaraVille">Mutiara Ville</option>
                            <option value="TheArc">The Arc</option>
                        </select><br>
                        <input type="hidden" id="start_location_lat" name="start_location_lat">
                        <input type="hidden" id="start_location_lng" name="start_location_lng">
                    </div>

                    <div class="inner-center">
                        <label for="end_location">End Location</label>
                        <br>
                        <select name="end_location" id="end_location" required>
                            <option value="Guard House">Guard House</option>
                            <option value="FCI">FCI</option>
                            <option value="FCM">FCM</option>
                            <option value="FOE">FOE</option>
                            <option value="FCM">FCM</option>
                            <option value="STC">STC</option>
                            <option value="MMUSTADIUM">MMU STADIUM</option>
                            <option value="DTC">DTC</option>
                            <option value="HB4">HB4</option>
                            <option value="HB2">HB2</option>
                        </select><br>
                        <input type="hidden" id="end_location_lat" name="end_location_lat">
                        <input type="hidden" id="end_location_lng" name="end_location_lng">
                    </div>
                </div>
                
                <!-- Google Map displaying start_location location -->
                <div id="map"></div>

                <div class="left-right">
                    <div class="inner-center">
                        <label for="carplate">Car Plate</label>
                        <br>
                        <input id="carplate" type="text" name="carplate" required placeholder="Enter Car Plate"><br>
                    </div>

                    <div class="inner-center">
                        <label for="carmodel">Car Model</label>
                        <br><input id="carmodel" type="text" name="carmodel" required placeholder="Enter Car Model"><br>
                    </div>
                </div>

                <div class="inner-center">
                    <label for="totalperson">Maximum Number of Passengers</label>
                    <br>
                    <input type="number" id="totalperson" name="totalperson" min="0" max="6" required>
                </div>

                <script>
                    function feesFunction() {
                        var fees = document.getElementById("fees").value;
                        var duitnowid = document.getElementById("duitnowid");

                        if (fees === "RM1") {
                            duitnowid.style.display = "block";
                        } else {
                            duitnowid.style.display = "none";
                        }
                    }
                </script>

                <div class="inner-center">
                    <label for="fees">Fees</label>
                    <br>
                    <select id="fees" name="fees" onchange="feesFunction()">
                        <option value="Free">Free</option>
                        <option value="RM1">RM1 per person</option>
                    </select><br>
                </div>

                <div class="inner-center" id="duitnowid" style="display: none;">
                    <label for="duitnowid">DuitNow ID</label>
                    <br>
                    <input type="text" name="duitnowid" placeholder="Enter Your DuitNow ID"><br>
                </div>

                <div class="inner-center">
                    <label for="message">Note</label>
                    <textarea id="message" name="message" rows="10" cols="30" placeholder="Enter Note..."></textarea><br><br>
                </div>

                <a href="/base_driver">
                    <input type="submit" value="Submit" class="btn">
                </a>
            </form>
        </div>
    </div>
</body>
</html>
